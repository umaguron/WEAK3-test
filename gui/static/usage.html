<!DOCTYPE html>
<html lang="ja">
<head>
    <title>usage</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>cmesh1</h1>
        <div class="row">
            <div class="col">
                <p>まずはじめに、各種実行ファイルや、インプットファイルの作成場所をsetting.iniに指定する必要がある。<a href="/setting.ini" download>ダウンロード</a></p>
                <p>setting.ini 各項目の説明は以下の通り。</p>
            </div>
        </div>    
        <br>
        <div class="row">
            <table class="table">
                <thead>
                    <tr>
                        <td><b>section</b></td>
                        <td></td>
                        <td><b>key</b></td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    <!-- <tr>
                        <th rowspan="3">[toughexec]</th>
                        <td rowspan="3">TOUGHプログラムの置き場所</td>
                        <td><b>BIN_DIR</b></td>
                        <td>
                            <ul class="list-unstyled">
                                <li>TOUGH3の各モジュールの実行ファイル(User's Guideに従い、コンパイルしたもの。tough3-eco2n_v2など。)が含まれるディレクトリ(フルパス)</li>
                                <li>おそらく、(...)/TOUGH3v1.x/TOUGH3-Code/esd-tough3/tough3-install/bin になる</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td><b>BIN_DIR_T2</b></td>
                        <td>(TOUGH2も使いたい場合のみ設定。)TOUGH2の各モジュールの実行ファイルが含まれるディレクトリ(フルパス)</td>
                    </tr>
                    <tr>
                        <td><b>BIN_DIR_LOCAL</b></td>
                        <td>上2つとは別にTOUGH3実行ファイルの場所を指定できる。WSに持っていく前に自分の端末でテストしたいときなどに便利。</td>
                    </tr> -->
                    <tr>
                        <th>[toughConfig]</th>
                        <td></td>
                        <td><b>TOUGH_INPUT_DIR</b></td>
                        <td>シミュレーションごとのフォルダがこのディレクトリ配下に作成され、input/output fileが書き出される。</td>
                    </tr>
                    <!-- <tr>
                        <th rowspan="8">[toughConfig]</th>
                        <td rowspan="8"></td>
                        <td><b>t2dataDir</b></td>
                        <td>シミュレーションごとのフォルダがこのディレクトリ配下に作成され、input/output fileが書き出される。</td>
                    </tr>
                    <tr>
                        <td colspan="2">その他の項目については、以下のようにする。</td>
                    </tr>
                    <tr><td>T3OUT_ESCAPE_DIRNAME</td><td>0t3out</td></tr>
                    <tr><td>SAVEFIG_DIRNAME</td><td>0fig</td></tr>
                    <tr><td>INCON_FILE_NAME</td><td>INCON</td></tr>
                    <tr><td>SAVE_FILE_NAME</td><td>SAVE</td></tr>
                    <tr><td>OUTPUT_ELEME_CSV_FILE_NAME</td><td>OUTPUT_ELEME.csv</td></tr>
                    <tr><td>OUTPUT_CONNE_CSV_FILE_NAME</td><td>OUTPUT_CONNE.csv</td></tr>
                    <tr>
                        <th rowspan="5">[ameshexec]</th>
                        <td rowspan="5">AMESH (Haukwa, 1998)実行ファイルの場所</td>
                        <td><b>AMESH_PROG</b></td>
                        <td>AMESH実行可能ファイルの名前</td>
                    </tr>
                    <tr>
                        <td><b>AMESH_DIR</b></td>
                        <td>AMESH_PROGがおいてあるディレクトリ（フルパス）/td>
                    </tr>
                    <tr>
                        <td colspan="2">その他の項目については、以下のようにする。</td>
                    </tr>
                    <tr><td>INPUT_FILENAME</td><td>in</td></tr>
                    <tr><td>SEGMT_FILENAME</td><td>segmt</td></tr> -->
                </tbody>
            </table>
        </div>
        <br>
        <div class="row">
            <div class="col">
                作成したsetting.iniをTOUGH3プロジェクト内の適当な場所に配置し、パスを<b>Path of setting config file</b>に入力し、<button class="btn btn-primary">check</button>を押下する。
            </div>
        </div>
        <div class="row">
            <div class="col">
                問題なければファイルの中身と<button class="btn btn-primary">go next</button>が表示される
            </div>
        </div>
        <br>
        <br>
        <br>
        <h1>cmesh2</h1>
        <br>
        <div class="row">
            <div class="col">
                <ul class="list-unstyled">
                    <li>AMESH(Haukwa, 1998)を使用して、MULGRAPH (O'sullivan and Bullivant, 1995)形式のメッシュファイルを作成する</li>
                    <li>MULgraphについての詳しい説明はpyTOUGHマニュアルのappendix. Aを参照。</li>
                    <li>まず2次元の平面グリッドを作成し、それをレイヤー状に積み重ねることで3次元グリッドを作成する。</li>
                    <li>最後に地形データをもとに、上部の要素を削って地形を再現する。</li>
                </ul>
            </div>
        </div>
        <br>
        <div class="row">
            <table class="table">
                <thead>
                    <tr>
                        <td></td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Use existing mulgrid file</td>
                        <td>すでに作成済みのmulgraphファイルを読み込む。</td>
                    </tr>
                    <tr>
                        <td>Create new mulgrid file</td>
                        <td>mulgraphファイルを新規作成する。</td>
                    </tr>
                </tbody>
            </table>
            <table class="table">
                <thead>
                    <tr>
                        <td></td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Path of mulgrid file</th>
                        <td>既存 or これから作成するmulgraphファイルのパス</td>
                    </tr>
                    <tr>
                        <th>MULgraph geometry file Naming conventions</th>
                        <td>MULgraphでは要素名を'カラム名'+'レイヤー名'の5文字で表現する(e.g., 'abc12')。英数字の割り振りは以下の3つから選択。
                        <ul>
                            <li>カラム: 英字3文字/レイヤー: 数字2桁</li>
                            <li>レイヤー: 英字3文字/カラム: 数字2桁</li>
                            <li>レイヤー: 英字2文字/カラム: 数字3桁</li>
                        </ul>
                        </td>
                    </tr>
                    <tr>
                        <th>topodata_fp</th>
                        <td>
                            <p>地形データ。形式は以下の通り。xは北方向、yは東方向、zは標高。各数値の単位は[km]</p>   
                            <img src="/img/topodata.png">
                        </td>
                    </tr>
                    <tr>
                        <th>voronoi_seeds_list_fp</th>
                        <td>
                            <p>2次元平面グリッドを定義。<a href="https://ja.wikipedia.org/wiki/%E3%83%9C%E3%83%AD%E3%83%8E%E3%82%A4%E5%9B%B3">voronoiメッシュ</a>作成時に使用される、各セルの"seed"(母点)となる座標のリスト。形式は以下の通り。単位は[m]</p>   
                            <img src="/img/voro_sample.png">
                        </td>
                    </tr>
                    <tr>
                        <th>elevation_top_layer</th>
                        <td>メッシュ作成領域内の最高地点より高い標高[m]を入力する。 </td>
                    </tr>
                    <tr>
                        <th>layer_thicknesses</th>
                        <td>各レイヤーの厚さを定義する配列(python3形式)。 上面のレイヤーから順番に並べること。単位は[m]。</td>
                    </tr>
                    <tr>
                        <th>top_layer_min_thickness</th>
                        <td>最上位ブロックの厚さの最小値。地表面より上部のレイヤーを削ったり厚さを変更することでメッシュ上に地形が表現されるが、この値より薄くなることはない。 </td>
                    </tr>
                    <tr>
                        <th>tolar [m]</th>
                        <td>AMESHの設定値. the length of the minimum interface between elements.  </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <br>
        <div class="row">
            <div class="col">
                <button class="btn btn-primary">Create or check</button> を押下。
                問題なければ <button class="btn btn-primary">Go next</button> が表示される
            </div>
        </div>
        <br>
        <br>
        <br>
        <h1>cmesh3</h1>
        <br>
        <h4>General</h4>
        <div class="row">
            <table class="table">
                <thead>
                    <tr>
                        <td></td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>problem name </th>
                        <td>この名前のフォルダがsetting.iniで指定したディレクトリ内部に作成され、各種ファイルが書き出される。すでにこの名前のフォルダが有る場合はエラーになる。</td>
                    </tr>
                    <tr>
                        <th>Resistivity structure data </th>
                        <td>
                            <p>以下の形式で作成された比抵抗構造データファイルのパスを指定する。</p>
                            <p>resは比抵抗[Ω], xはNorthing[m], yはEasting[m], zはdepth below sea level [m]</p>
                            <img src="/img/resdata.png">
                        </td>
                    </tr>
                    <tr>
                        <th>seedFlg </th>
                        <td>
                            今はまだうまく行かない（原因不明）。チェックを外しておく。
                        </td>
                    </tr>
                    <tr>
                        <th>boundary_side_permeable </th>
                        <td>側面に温度不変の透水境界を設定する。(仮想的に領域最外縁の要素に巨大な体積を与える。結果として、最外縁要素とその内側の要素は温度一定(初期条件から不変)の透水境界になる。)   </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <br>
        <br>
        <h4>Atmosphere block</h4>
        <div class="row">
            <div class="col">
                空気層の設定。use defaultを押下すると空欄に適当な値が設定される。
            </div>
        </div>
        <br>
        <br>
        <h4>Rocktype #XX</h4>
        <div class="row">
            <div class="col">
                porosityやpermeabilityの異なる複数の岩石タイプを設定可能。
                Rocktypeの数を増やしたいときは、gui/constants.pyのROCKTYPE_LENを増やす。
                use defaultを押下すると空欄に適当な値が設定される。
            </div>
        </div>
        <br>
        <br>
        <h5><b>各要素への割り当て方法</b></h5>  
        <br>
        <h6><b>1. 要素名で直接指定</b></h6>  
        <div class="row">
            <div class="col">
                blocklistにlist形式で要素名を指定。無条件でそのrocktypeが割り当てられる
            </div>
        </div>
        <br>
        <h6><b>2. 範囲+割り当て条件式による指定</b></h6>  
        <div class="row">
            <div class="col">
                rectangular region、かつrock_assign_conditionに指定された条件を満たす要素。
            </div>
        </div>
        <div style="color: red;">注意) ある要素について、複数の岩石タイプの割り当て条件に合致してしまう場合、番号が大きい岩石タイプが優先的に割り当てられる。
        </div>
        <br>
        <br>
        <h5>formula_porosity / formula_permeability </h5>
        <div class="row">
            <div class="col">
                <ul>
                    <li>formula_porosity, formula_permeabilityには、porosity, permeabilityの算出式を書くことができる。それぞれの式はeval関数で評価され、値が porosity, permに代入される。</li>
                    <li>seedFlgがtrueのとき、permは、rectangular regionとrock_assign_conditionを満たす要素の浸透率として、rocktypeの設定値を上書きする形で割り当てられる。ただし、TOUGH3での計算が不安定になるので現時点では実用的でない。原因調査中。</li>
                    <li>porosityはformula_permeabilityとrock_assign_condition, permはrock_assign_conditionの式に使用することができる。</li>
                    <li>使用しない場合はNoneを入力する。</li>
                </ul>
            </div>
        </div>
        <br>
        <h5> rock_assign_condition  </h5>
        <ul>
            <li>rocktypeを割り当てる条件式。</li>
            <li>rock_assign_conditionはpython3のeval関数で評価される。</li>
            <li>式がTrueと判定される要素にこのrocktypeが適用される</li>
        </ul>
        <div class="row">
            <table class="table">
            <thead>
                <tr>
                    <td>条件</td>
                    <td>rock_assign_condition</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>rectangular regionに含まれるすべての要素</td>
                    <td>True</td>
                </tr>
                <tr>
                    <td>地表から深さ500m以上の要素</td>
                    <td>depth > 500</td>
                </tr>
                <tr>
                    <td>標高0m以上かつ、座標中心から2km以内</td>
                    <td>z > 0 and (x**2 + y**2)**0.5 < 2000</td>
                </tr>
                <tr>
                    <td>比抵抗が5Ωm以下の要素</td>
                    <td>rho < 5</td>
                </tr>
            </tbody>
            </table>
        </div>
        <br>
        <div class="row">
            <div class="col">
                一番下の <button class="btn btn-primary btn-small">Check</button> を押下すると、tough3のメッシュのテスト作成を行う。エラーがなければcmesh4の画面に遷移する。
            </div>
        </div>
        <br>
        <br>
        <br>
        <h1>cmesh4</h1>
        <div class="row">
            <ul class="list-unstyled">
                <li>上部に作成されたグリッドファイルと、ここまで入力したメッシュ情報が書き出されたinput.iniのパス、それらが書き出されたディレクトリ（problem directory）が表示されている。</li>
                <li>後半は作成された浸透率構造の断面図を、もととなった比抵抗構造と比較することができる。</li>
                <li>問題なければ <button class="btn btn-primary btn-small">Go to cmesh5</button>を押下し、TOUGH3シミュレーションのパラメータ設定に進む。</li>
            </ul>
        </div>
        <div class="row">
            <h4>Slices</h4>
            <div class="col">  
                <ul class="">
                    <li><b>line #0 - #5</b>のテキストボックスには説明に従って、作成したい断面の位置を定義する。</li>
                    <li>各断面図の描画範囲は、<b>Axial range of slices</b>で指定可能。（すべての図に一括適用されることに注意）</li>
                    <li>recreate slicesを押下すると入力値をもとに断面を作り直す。</li>
                </ul>
                <ul class="list-unstyled">
                    <li>作成された断面はproblem directoryにも保存される。</li>
                    <li>ここで定義した断面の情報はinput.iniに記録され、シミュレーション結果の断面図(温度、塩濃度、比抵抗など)を描画する際にも使われる。</li>
                </ul>
            </div>
        </div>
        <div class="row">  
            <b>plan view</b>
            <ul class="list-unstyled">
                <li>作成したメッシュの平面図（セル上にはカラムindex）</li>
            </ul>
            <b>line #0 - 5</b>
            <ul class="list-unstyled">
                <li>Slicesの各テキストボックスで指定した位置での断面図</li>
            </ul>
        </div>
        <div class="row">  
            <h5><b>その他</b></h5>
            <div class="col">  
                <ul class="">
                    <li>ここまでの情報はすでにinput.iniに記録されているので、ここで中断しても問題ない。</li>
                    <li><a href="http://localhost:8000/">home</a>の"read from existing input.ini (cmesh3_readFromIni)"にinput.iniのパスを指定すればcmesh3の設定から再開可能。</li>
                    <li>cmesh4までに作成されたinput.iniは不完全なため、makeGridAmeshVoro.py, tough3exec_ws.py, run.pyに食わせてもエラーになる。</li>
                </ul>
            </div>
        </div>
        <br>
        <br>
        <h1>cmesh5</h1>
        <div class="row">
            <ul class="list-unstyled">
                <li>シミュレーションのパラメータ設定を行う。</li>
                <li>各パラメータフォームの横にはTOUGH3 マニュアルからコピーした説明が書いてある。全部ではないので詳細はマニュアルを参照すること。</li>
                <li>メッシュ情報(cmesh4まで)が作成済みの場合、<a href="http://localhost:8000/">home</a>の"read from existing input.ini (cmesh5)"にinput.iniのパスを指定すればcmesh5の設定から再開可能。</li>
            </ul>
            
            <h4>INCON</h4>
            <p>初期条件を指定する。３種類の初期条件が指定可能。</p>
            <div class="col">
                <ul>
                    <li><b>前回のシミュレーションの終了状態</b></li>
                    <ul>
                        <li>TOUGH3シミュレーション終了時に出力されるSAVEのファイルパスを指定する。</li>
                        <li>同じ形状のメッシュを使ったシミュレーションであることが必要</li>
                    </ul>
                    <li><b>1次元鉛直シミュレーションの結果</b></li>
                    <ul>
                        <li>１次元鉛直グリッドによるシミュレーション結果(温度、圧力)を地表を上端として各カラムに貼り付ける。</li>
                        <li>１次元シミュレーションの結果は補間されるため、グリッド間隔は同じである必要はない。</li>
                        <li>貼り付け先のメッシュより深部までのシミュレーション結果が必要(補間できずエラーになる)</li>
                    </ul>
                    <li><b>静水圧かつ一定の地温勾配</b></li>
                    <ul>
                        <li>地温勾配は、地殻熱流量と岩石の熱伝導率で決まる。これらを各テキストボックス指定すると地温勾配が計算される。</li>
                        <li>計算された地温勾配のみinput.iniに記録される。</li>
                    </ul>
                </ul>
            </div>
        </div>
        <div class="row">
            <h4>GENER</h4>
            <div class="col">
                <ul>
                    <li>流体を注入する場合、注入ブロックと流量、温度をここで指定する。</li> 
                    <li>温度はエンタルピーに変換されTOUGH3の入力として使用される。</li> 
                    <li>NaClやCO2に関しては温度→エンタルピーの変換を実装していないため、どんな温度を設定しても0kJ/kgになることに注意。</li> 
                </ul>
            </div>
        </div>
        <br>
        <div class="row">
            <p>一番下の <button class="btn btn-primary btn-small">Check</button> を押下すると、入力された情報をもとにinput.iniの作成を行う。input.ini作成に成功すると 
                <button type="button" class="btn btn-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Download
                </button>
                と 
                <button class="btn btn-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-forward" viewBox="0 0 16 16">
                        <path d="M9.502 5.513a.144.144 0 0 0-.202.134V6.65a.5.5 0 0 1-.5.5H2.5v2.9h6.3a.5.5 0 0 1 .5.5v1.003c0 .108.11.176.202.134l3.984-2.933a.51.51 0 0 1 .042-.028.147.147 0 0 0 0-.252.51.51 0 0 1-.042-.028L9.502 5.513zM8.3 5.647a1.144 1.144 0 0 1 1.767-.96l3.994 2.94a1.147 1.147 0 0 1 0 1.946l-3.994 2.94a1.144 1.144 0 0 1-1.767-.96v-.503H2a.5.5 0 0 1-.5-.5v-3.9a.5.5 0 0 1 .5-.5h6.3v-.503z"/>
                    </svg>
                    Create inputs
                </button>
                が画面上部に表示される。</p>
            <div class="col">
                <ul class="">
                    <li><b>Download</b>では作成したinput.iniをダウンロードできる。</li>
                    <li><b>Create inputs</b>を押下すると作成されたinput.iniを用いてメッシュとTOUGH3インプットファイルの作成を行う。</li>
                    <ul class="">
                        <li>makeGridAmeshVoro.py, tough3exec_ws.py を使用</li>
                        <li>input.iniのエラーチェックも兼ねて実行しておくのがおすすめ。</li>
                    </ul>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
<!-- 
    <div class="row">
    <div class="col">
    </div>
</div>
<div class="row">
    <table class="table">
        <thead>
            <tr>
                <td><b>section</b></td>
                <td></td>
                <td><b>key</b></td>
                <td></td>
            </tr>
        </thead>
        <tbody>
            <tr></tr>
        </tbody>
    </table>
</div> 
-->